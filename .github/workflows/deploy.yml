name: GitHub Actions Demo
run-name: ${{ github.actor }} deploying theme to ghost website
on: [push]
jobs:
  Build-Theme-and-Deploy:
    runs-on: ubuntu-latest
    env:
      # Set these in GitHub â†’ Settings â†’ Secrets and variables â†’ Actions
      GHOST_ADMIN_URL: ${{ secrets.GHOST_ADMIN_URL }}
      GHOST_ADMIN_API_KEY: ${{ secrets.GHOST_ADMIN_API_KEY }} 
    steps:
      - run: echo "ğŸ‰ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "ğŸ§ This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "ğŸ” The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v5
      - run: echo "ğŸ’¡ The ${{ github.repository }} repository has been cloned to the runner."
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          # cache: 'yarn'
      - name: Install dependencies (Yarn)
        run: yarn
      - name: Build theme (optional)
        run: |
          # If your theme has a build step, keep this. If not, it will no-op.
          if yarn run | grep -q "^  build"; then
            yarn build
          else
            echo "No build script found; skipping build."
          fi
      - name: Package theme with yarn zip
        id: zip
        run: |
          set -euo pipefail
          # This should create a zip, commonly named like <name>-<version>.zip in the repo root
          yarn zip

          # Find the most recent zip produced
          ZIP_FILE=$(ls -1t dist/*.zip | head -n1)
          if [ -z "${ZIP_FILE}" ]; then
            echo "No zip found after 'yarn zip'"
            exit 1
          fi
          echo "zip=${ZIP_FILE}" >> $GITHUB_OUTPUT
          echo "Created zip: ${ZIP_FILE}"     
      - name: Upload theme to Ghost Admin API
        id: upload
        env:
          ZIP_FILE: ${{ steps.zip.outputs.zip }}
        run: |
          set -euo pipefail

          if [ -z "${GHOST_ADMIN_URL}" ] || [ -z "${GHOST_ADMIN_API_KEY}" ]; then
            echo "GHOST_ADMIN_URL or GHOST_ADMIN_API_KEY is missing"
            exit 1
          fi

          UPLOAD_URL="${GHOST_ADMIN_URL%/}/ghost/api/admin/themes/upload/"
          AUTH="Ghost ${GHOST_ADMIN_API_KEY}"

          echo "Uploading theme: ${ZIP_FILE} â†’ ${UPLOAD_URL}"

          RESPONSE=$(curl -sS -X POST "${UPLOAD_URL}" \
            -H "Authorization: ${AUTH}" \
            -H "Accept: application/json" \
            -F "file=@${ZIP_FILE};type=application/zip")

          echo "Upload response: ${RESPONSE}"

          THEME_SLUG=$(echo "${RESPONSE}" | jq -r '.themes[0].name // empty')
          if [ -z "${THEME_SLUG}" ]; then
            echo "Failed to parse upload response. Aborting."
            exit 1
          fi

          echo "uploaded_theme=${THEME_SLUG}" >> $GITHUB_OUTPUT
          echo "Uploaded theme slug: ${THEME_SLUG}"
      - name: Upload artifact (zip)
        uses: actions/upload-artifact@v4
        with:
          name: theme-zip
          path: ${{ steps.zip.outputs.zip }}
          retention-days: 7
      - run: echo "ğŸ This job's status is ${{ job.status }}."
