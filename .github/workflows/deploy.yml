name: GitHub Actions Demo
run-name: ${{ github.actor }} deploying theme to ghost website
on: [push]
jobs:
  Build-Theme-and-Deploy:
    runs-on: ubuntu-latest
    env:
      # Set these in GitHub → Settings → Secrets and variables → Actions
      GHOST_ADMIN_URL: ${{ secrets.GHOST_ADMIN_URL }}
      GHOST_ADMIN_API_KEY: ${{ secrets.GHOST_ADMIN_API_KEY }} 
    steps:
      - name: Check out repository code
        uses: actions/checkout@v5
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'yarn'
          cache-dependency-path: yarn.lock
      - name: Install dependencies (Yarn)
        run: yarn
      - name: Build theme (optional)
        run: |
          # If your theme has a build step, keep this. If not, it will no-op.
          if yarn run | grep -q "^  build"; then
            yarn build
          else
            echo "No build script found; skipping build."
          fi
      - name: Package theme with yarn zip
        id: zip
        run: |
          set -euo pipefail
          mkdir -p dist
          # This should create a zip, commonly named like <name>-<version>.zip in the repo root
          yarn zip

          # Find the most recent zip produced
          ZIP_FILE=$(find dist -maxdepth 1 -type f -name '*.zip' -print0 | xargs -0 -r ls -1t | head -n1)
          if [ -z "${ZIP_FILE}" ]; then
            echo "No zip found after 'yarn zip'"
            exit 1
          fi
          echo "zip=${ZIP_FILE}" >> $GITHUB_OUTPUT
          echo "Created zip: ${ZIP_FILE}"     
      - name: Upload theme to Ghost Admin API
        id: upload
        env:
          ZIP_FILE: ${{ steps.zip.outputs.zip }}
        run: |
          set -euo pipefail

          if [ -z "${GHOST_ADMIN_URL}" ] || [ -z "${GHOST_ADMIN_API_KEY}" ]; then
            echo "GHOST_ADMIN_URL or GHOST_ADMIN_API_KEY is missing"
            exit 1
          fi

          #!/usr/bin/env bash

          # Admin API key goes here
          KEY="${GHOST_ADMIN_API_KEY}"

          # Split the key into ID and SECRET
          TMPIFS=$IFS
          IFS=':' read ID SECRET <<< "$KEY"
          IFS=$TMPIFS

          # Prepare header and payload
          NOW=$(date +'%s')
          FIVE_MINS=$(($NOW + 300))
          HEADER="{\"alg\": \"HS256\",\"typ\": \"JWT\", \"kid\": \"$ID\"}"
          PAYLOAD="{\"iat\":$NOW,\"exp\":$FIVE_MINS,\"aud\": \"/admin/\"}"

          # Helper function for performing base64 URL encoding (binary safe)
          base64_url_encode() {
              openssl base64 -A | tr -d '=' | tr '+/' '-_'
            }

          # Prepare the token body
          header_base64=$(printf '%s' "$HEADER" | base64_url_encode)
          payload_base64=$(printf '%s' "$PAYLOAD" | base64_url_encode)

          header_payload="${header_base64}.${payload_base64}"

          # Create the signature
          signature=$(printf '%s' "${header_payload}" | openssl dgst -binary -sha256 -mac HMAC -macopt hexkey:$SECRET | base64_url_encode)

          # Concat payload and signature into a valid JWT token

          TOKEN="${header_payload}.${signature}"
          
          UPLOAD_URL="${GHOST_ADMIN_URL%/}/ghost/api/admin/themes/upload/"

          echo "Uploading theme: ${ZIP_FILE} → ${UPLOAD_URL}"

          # curl -H "Authorization: Ghost $TOKEN" \
          #   -H "Content-Type: application/json" \
          #   -H "Accept-Version: v3.0" \
          #   -d '{"posts":[{"title":"Hello world"}]}' \
          #   "${GHOST_ADMIN_URL}/ghost/api/admin/posts/"
          
          RESPONSE=$(curl --fail --show-error -X POST -F "file=@${ZIP_FILE}" -H "Authorization: Ghost $TOKEN" -H "Accept-Version: v3.0" "${UPLOAD_URL}")
          echo "Upload response: ${RESPONSE}"

          THEME_SLUG=$(echo "${RESPONSE}" | jq -r '.themes[0].name // empty')
          if [ -z "${THEME_SLUG}" ]; then
            echo "Failed to parse upload response. Aborting."
            exit 1
          fi

          echo "uploaded_theme=${THEME_SLUG}" >> $GITHUB_OUTPUT
          echo "Uploaded theme slug: ${THEME_SLUG}"
      # - name: Activate theme
      #   env:
      #     THEME_TO_ACTIVATE: ${{ steps.upload.outputs.uploaded_theme }}
      #   run: |
      #     set -euo pipefail

      #     ACTIVATE_URL="${GHOST_ADMIN_URL%/}/ghost/api/admin/themes/${THEME_TO_ACTIVATE}/activate/"
      #     AUTH="Ghost ${GHOST_ADMIN_API_KEY}"

      #     echo "Activating theme: ${THEME_TO_ACTIVATE}"

      #     RESPONSE=$(curl -sS -X PUT "${ACTIVATE_URL}" \
      #       -H "Authorization: ${AUTH}" \
      #       -H "Accept: application/json")

      #     echo "Activate response: ${RESPONSE}"

      #     ACTIVE=$(echo "${RESPONSE}" | jq -r '.themes[0].active // empty')
      #     if [ "${ACTIVE}" != "true" ]; then
      #       echo "Theme failed to activate"
      #       exit 1
      #     fi
      - name: Upload artifact (zip)
        uses: actions/upload-artifact@v4
        with:
          name: theme-zip
          path: ${{ steps.zip.outputs.zip }}
          retention-days: 7
